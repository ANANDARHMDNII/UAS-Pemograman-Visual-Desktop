<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix Undefined PDF - Cappunabara</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 2rem;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            margin: 0;
            min-height: 100vh;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 3rem;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border: 1px solid #e9ecef;
        }
        h1 {
            color: #8B6F47;
            text-align: center;
            margin-bottom: 2rem;
            font-size: 2.5rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        .coffee-icon {
            text-align: center;
            font-size: 4rem;
            margin-bottom: 1rem;
        }
        .problem-section {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            border: 2px solid #ffc107;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
        }
        .problem-section h3 {
            color: #856404;
            margin-bottom: 15px;
            font-size: 20px;
        }
        .problem-section p {
            color: #856404;
            margin-bottom: 10px;
            font-weight: 500;
        }
        .solution-section {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            border: 2px solid #28a745;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
        }
        .solution-section h3 {
            color: #155724;
            margin-bottom: 15px;
            font-size: 20px;
        }
        .solution-section ul {
            color: #155724;
            margin-left: 20px;
        }
        .solution-section li {
            margin-bottom: 8px;
            font-weight: 500;
        }
        .big-btn {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 20px 30px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            width: 100%;
            margin: 15px 0;
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .big-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(40, 167, 69, 0.4);
        }
        .debug-btn {
            background: linear-gradient(135deg, #17a2b8, #138496);
            box-shadow: 0 4px 12px rgba(23, 162, 184, 0.3);
        }
        .debug-btn:hover {
            box-shadow: 0 6px 16px rgba(23, 162, 184, 0.4);
        }
        .test-btn {
            background: linear-gradient(135deg, #ffc107, #e0a800);
            box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3);
        }
        .test-btn:hover {
            box-shadow: 0 6px 16px rgba(255, 193, 7, 0.4);
        }
        .result {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border: 2px solid #8B6F47;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        .success { 
            color: #28a745; 
            font-weight: bold; 
            font-size: 16px;
        }
        .error { 
            color: #dc3545; 
            font-weight: bold; 
            font-size: 16px;
        }
        .warning {
            color: #ffc107;
            font-weight: bold;
            font-size: 16px;
        }
        .link-section {
            text-align: center;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 2px solid #f1f3f4;
        }
        .link-btn {
            display: inline-block;
            background: linear-gradient(135deg, #8B6F47, #A67B5B);
            color: white;
            padding: 15px 25px;
            text-decoration: none;
            border-radius: 25px;
            font-weight: 700;
            margin: 10px;
            box-shadow: 0 4px 12px rgba(139, 111, 71, 0.3);
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .link-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(139, 111, 71, 0.4);
        }
        .steps {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            border: 2px solid #2196F3;
        }
        .steps h4 {
            color: #1976D2;
            margin-bottom: 15px;
        }
        .steps ol {
            color: #1565C0;
            margin-left: 20px;
        }
        .steps li {
            margin-bottom: 8px;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="coffee-icon">üîß</div>
        <h1>üõ†Ô∏è Fix Undefined PDF</h1>
        
        <div class="problem-section">
            <h3>‚ùå Masalah yang Ditemukan:</h3>
            <p><strong>Ada tulisan "undefined" di PDF struk seperti ini:</strong></p>
            <p style="font-family: monospace; background: white; padding: 10px; border-radius: 5px;">
                undefined    Mocha Delight    Rp 76.000<br>
                             Rp 38.000 x 2
            </p>
            <p><strong>Penyebab:</strong> Data tidak lengkap di localStorage atau ada field yang kosong/null</p>
        </div>
        
        <div class="solution-section">
            <h3>‚úÖ Solusi yang Diterapkan:</h3>
            <ul>
                <li>üõ°Ô∏è <strong>Data Validation</strong> - Validasi semua field sebelum generate PDF</li>
                <li>üîÑ <strong>Fallback Values</strong> - Berikan nilai default untuk data yang kosong</li>
                <li>üßπ <strong>Data Sanitization</strong> - Bersihkan dan perbaiki data yang rusak</li>
                <li>‚ö†Ô∏è <strong>Error Handling</strong> - Alert dan logging untuk debugging</li>
                <li>üéØ <strong>Complete Test Data</strong> - Data test yang lengkap dan valid</li>
            </ul>
        </div>
        
        <div class="steps">
            <h4>üìã Langkah-langkah Perbaikan:</h4>
            <ol>
                <li><strong>Debug Data</strong> - Cek data yang ada di localStorage</li>
                <li><strong>Create Valid Data</strong> - Buat data test yang lengkap</li>
                <li><strong>Test Fixed PDF</strong> - Test PDF dengan data yang sudah diperbaiki</li>
                <li><strong>Verify Result</strong> - Pastikan tidak ada "undefined" lagi</li>
            </ol>
        </div>
        
        <button class="big-btn debug-btn" onclick="debugCurrentData()">
            1Ô∏è‚É£ DEBUG DATA SAAT INI
        </button>
        
        <button class="big-btn" onclick="createValidData()">
            2Ô∏è‚É£ BUAT DATA VALID
        </button>
        
        <button class="big-btn test-btn" onclick="testFixedPDF()">
            3Ô∏è‚É£ TEST PDF YANG SUDAH DIPERBAIKI
        </button>
        
        <div id="result" class="result">
            <strong>Status:</strong> Ready untuk memperbaiki masalah undefined...<br>
            <em>Klik tombol di atas untuk memulai perbaikan</em>
        </div>
        
        <div class="link-section">
            <a href="http://localhost:5140/debug-pdf-data.html" target="_blank" class="link-btn">
                üîç Debug Tools
            </a>
            <a href="http://localhost:5140/RiwayatPesanan" target="_blank" class="link-btn">
                üìú Riwayat Pesanan
            </a>
            <a href="http://localhost:5140/Order" target="_blank" class="link-btn">
                üõí Order Page
            </a>
        </div>
    </div>

    <!-- Load the fixed PDF generator -->
    <script src="fix-undefined-pdf.js"></script>
    
    <script>
        function debugCurrentData() {
            const result = document.getElementById('result');
            
            try {
                // Get current data from localStorage
                const orderHistoryRaw = localStorage.getItem('cappunabara_order_history');
                const customerDataRaw = localStorage.getItem('cappunabara_customer_data');
                
                let debugInfo = 'üîç DEBUG HASIL:\n\n';
                
                // Check order history
                if (!orderHistoryRaw) {
                    debugInfo += '‚ùå TIDAK ADA ORDER HISTORY di localStorage\n';
                } else {
                    try {
                        const orderHistory = JSON.parse(orderHistoryRaw);
                        debugInfo += `‚úÖ Order History ditemukan: ${orderHistory.length} orders\n`;
                        
                        if (orderHistory.length > 0) {
                            const order = orderHistory[0];
                            debugInfo += `\nüìä DATA ORDER PERTAMA:\n`;
                            debugInfo += `‚Ä¢ ID: ${order.id || 'UNDEFINED ‚ùå'}\n`;
                            debugInfo += `‚Ä¢ Customer Name: ${order.customer?.name || 'UNDEFINED ‚ùå'}\n`;
                            debugInfo += `‚Ä¢ Customer Table: ${order.customer?.table || 'UNDEFINED ‚ùå'}\n`;
                            debugInfo += `‚Ä¢ Customer Payment: ${order.customer?.payment || 'UNDEFINED ‚ùå'}\n`;
                            debugInfo += `‚Ä¢ Items Count: ${order.items?.length || 0}\n`;
                            debugInfo += `‚Ä¢ Total: ${order.total || 'UNDEFINED ‚ùå'}\n`;
                            
                            if (order.items && order.items.length > 0) {
                                debugInfo += `\nüçΩÔ∏è ITEMS DETAIL:\n`;
                                order.items.forEach((item, index) => {
                                    debugInfo += `${index + 1}. Name: ${item.name || 'UNDEFINED ‚ùå'}\n`;
                                    debugInfo += `   Quantity: ${item.quantity || 'UNDEFINED ‚ùå'}\n`;
                                    debugInfo += `   Price: ${item.price || 'UNDEFINED ‚ùå'}\n`;
                                });
                            }
                            
                            // Check for undefined values
                            const hasUndefined = !order.id || !order.customer?.name || !order.customer?.table || 
                                               !order.items || order.items.some(item => !item.name || !item.quantity || !item.price);
                            
                            if (hasUndefined) {
                                debugInfo += `\n‚ö†Ô∏è DITEMUKAN DATA UNDEFINED! Ini penyebab masalah di PDF.\n`;
                            } else {
                                debugInfo += `\n‚úÖ Semua data lengkap, tidak ada undefined.\n`;
                            }
                        }
                    } catch (e) {
                        debugInfo += '‚ùå ERROR parsing order history: ' + e.message + '\n';
                    }
                }
                
                // Check customer data
                if (!customerDataRaw) {
                    debugInfo += '\n‚ùå TIDAK ADA CUSTOMER DATA di localStorage\n';
                } else {
                    debugInfo += '\n‚úÖ Customer Data ditemukan\n';
                }
                
                debugInfo += '\nüéØ KESIMPULAN:\n';
                if (!orderHistoryRaw) {
                    debugInfo += '‚Ä¢ Perlu buat data test yang valid\n';
                    debugInfo += '‚Ä¢ Klik "BUAT DATA VALID" untuk fix\n';
                } else {
                    debugInfo += '‚Ä¢ Data ditemukan, cek apakah ada undefined\n';
                    debugInfo += '‚Ä¢ Jika ada undefined, klik "BUAT DATA VALID"\n';
                }
                
                result.innerHTML = `<span class="warning">üîç DEBUG SELESAI</span><br><br><pre>${debugInfo}</pre>`;
                
            } catch (error) {
                result.innerHTML = `<span class="error">‚ùå Error debugging: ${error.message}</span>`;
            }
        }
        
        function createValidData() {
            const result = document.getElementById('result');
            
            try {
                // Create completely valid test data
                const validOrder = createValidTestData();
                
                result.innerHTML = `
                    <span class="success">‚úÖ DATA VALID BERHASIL DIBUAT!</span><br><br>
                    <strong>Data yang dibuat:</strong><br>
                    ‚Ä¢ Order ID: ${validOrder.id}<br>
                    ‚Ä¢ Customer: ${validOrder.customer.name}<br>
                    ‚Ä¢ Table: ${validOrder.customer.table}<br>
                    ‚Ä¢ Payment: ${validOrder.customer.payment}<br>
                    ‚Ä¢ Items: ${validOrder.items.length} items<br>
                    ‚Ä¢ Total: Rp ${validOrder.total.toLocaleString('id-ID')}<br><br>
                    <strong>‚úÖ SEMUA FIELD LENGKAP - TIDAK ADA UNDEFINED!</strong><br><br>
                    <em>Sekarang klik "TEST PDF YANG SUDAH DIPERBAIKI"</em>
                `;
                
            } catch (error) {
                result.innerHTML = `<span class="error">‚ùå Error creating valid data: ${error.message}</span>`;
            }
        }
        
        function testFixedPDF() {
            const result = document.getElementById('result');
            
            try {
                const orderHistory = JSON.parse(localStorage.getItem('cappunabara_order_history') || '[]');
                
                if (orderHistory.length === 0) {
                    result.innerHTML = '<span class="error">‚ùå No orders found! Klik "BUAT DATA VALID" dulu.</span>';
                    return;
                }
                
                const order = orderHistory[0];
                
                // Test the fixed PDF function
                if (typeof createFixedPDF === 'function') {
                    createFixedPDF(order);
                    
                    result.innerHTML = `
                        <span class="success">‚úÖ PDF FIXED BERHASIL DITEST!</span><br><br>
                        <strong>Yang sudah diperbaiki:</strong><br>
                        ‚Ä¢ ‚úÖ Tidak ada "undefined" lagi<br>
                        ‚Ä¢ ‚úÖ Semua data divalidasi<br>
                        ‚Ä¢ ‚úÖ Fallback values untuk data kosong<br>
                        ‚Ä¢ ‚úÖ Error handling yang lebih baik<br>
                        ‚Ä¢ ‚úÖ Tab baru terbuka dengan PDF yang bersih<br><br>
                        <strong>Langkah selanjutnya:</strong><br>
                        1. Klik "PRINT/SAVE PDF" di tab baru<br>
                        2. Pilih "Save as PDF"<br>
                        3. Save ke komputer<br><br>
                        <strong>üéâ MASALAH UNDEFINED SUDAH TERATASI!</strong><br><br>
                        <em>Order: ${order.id} | Customer: ${order.customer.name}</em>
                    `;
                } else {
                    result.innerHTML = '<span class="error">‚ùå createFixedPDF function not found! Check if fix-undefined-pdf.js is loaded.</span>';
                }
                
            } catch (error) {
                result.innerHTML = `<span class="error">‚ùå Test Error: ${error.message}</span>`;
            }
        }
        
        // Show welcome message
        setTimeout(function() {
            console.log('üîß Fix Undefined PDF Page Loaded');
            console.log('üõ°Ô∏è Features: Data validation, fallback values, error handling');
        }, 1000);
    </script>
</body>
</html>